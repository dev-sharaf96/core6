<div class="row">
  <div class="col-xs-12">
    <h4 class="page-header">{{ 'policy.failure_policies' | translate }}</h4>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading" translate>common.filter_by</div>
      <!-- /.panel-heading -->
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-3">
            <div class="form-group">
              <label for="" translate>reports.products</label>
              <app-products-dropdown [(selectedValue)]="policiesFilter.productTypeId"></app-products-dropdown>
            </div>
          </div>
          <div class="col-xs-12 col-md-4">
            <div class="form-group">
              <label for="" translate>common.by_insurance_company</label>
              <app-shared-insurance-companies [(selectedValue)]="policiesFilter.insuranceCompanyId">
              </app-shared-insurance-companies>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="" translate>policy.policy_status</label>
              <app-policy-status-dropdown [(selectedValue)]="policiesFilter.policyStatusId">
              </app-policy-status-dropdown>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-3">
            <div class="form-group">
              <label for="invoiceNo" translate>policy.invoiceNo</label>
              <input type="text" [(ngModel)]="policiesFilter.invoiceNo" class="form-control" id="invoiceNo" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="sequenceNo" translate>policy.sequenceNo</label>
              <input type="text" [(ngModel)]="policiesFilter.sequenceNo" class="form-control" id="sequenceNo" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="customNo" translate>policy.customNo</label>
              <input type="text" [(ngModel)]="policiesFilter.customNo" class="form-control" id="customNo" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="insuredEmail" translate>policy.userEmail</label>
              <input type="text" [(ngModel)]="policiesFilter.insuredEmail" class="form-control" id="insuredEmail" />
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-3">
            <div class="form-group">
              <label for="nationalId" translate>policy.insured_NIN</label>
              <input type="text" [(ngModel)]="policiesFilter.nationalId" class="form-control" id="nationalId" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="insuredPhone" translate>policy.insured_phone</label>
              <input type="text" [(ngModel)]="policiesFilter.insuredPhone" class="form-control" id="insuredPhone" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="insuredFirstNameAr" translate>policy.insured_first_name</label>
              <input type="text" [(ngModel)]="policiesFilter.insuredFirstNameAr" class="form-control"
                id="insuredFirstNameAr" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="insuredLastNameAr" translate>policy.insured_last_Arabic_Name</label>
              <input type="text" [(ngModel)]="policiesFilter.insuredLastNameAr" class="form-control"
                id="insuredLastNameAr" />
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12 col-md-6">
            <label for="fdate" translate>policy.policy_issue_date</label>
            <div class="form-group">
              <div class="row">
                <div class="col-md-6">
                  <!-- put the ngModel -->
                  <p-calendar [(ngModel)]="policiesFilter.startDate" [showIcon]="true"
                    [placeholder]="'common.from' | translate" [maxDate]="policiesFilter.endDate || today"
                    styleClass="w-100" inputStyleClass="form-control"></p-calendar>
                </div>
                <div class="col-md-6">
                  <!-- put the ngModel -->
                  <p-calendar [(ngModel)]="policiesFilter.endDate" [showIcon]="true"
                    [placeholder]="'common.to' | translate" [minDate]="policiesFilter.startDate" [maxDate]="today"
                    styleClass="w-100" inputStyleClass="form-control"></p-calendar>
                </div>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="referenceNo" translate>invoice.reference_id</label>
              <input type="text" [(ngModel)]="policiesFilter.referenceNo" class="form-control" id="referenceNo" />
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label for="channel" translate>requestLogs.channel</label>
              <app-channels-dropdown [(selectedValue)]="policiesFilter.channel"> </app-channels-dropdown>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="form-group">
              <label for="merchantid" translate>invoice.merchantId</label>
              <input type="text" [(ngModel)]="policiesFilter.merchantId" class="form-control" id="merchantId" />
            </div>
          </div>
          <div class="col-xs-12 col-md-2">
            <button (click)="filterClick(reportsTable)" [disabled]="isSearch" class="btn btn-primary" style="margin-top: 20px;" translate>
              common.search
            </button>
          </div>
        </div>
        <br />
      </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row" [ngClass]="{'hidden': firstTime}">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <a (click)="exportCsv()" class="pointer" translate>common.export</a>
        <button (click)="resetTraies()" [disabled]="selectedPolicies.length === 0"
          class="btn btn-primary details bx_right" translate>policy.reset</button>
        <div class="text-left clearfix">{{'common.results_count' | translate}} : {{FailurePoliciesCount}}
        </div>
      </div>
      <!-- /.panel-heading -->
      <div class="panel-body">
        <p-table #reportsTable [value]="policyListing" [lazy]="true" (onLazyLoad)="FailurePoliciesLazyLoad($event)"
          [lazyLoadOnInit]="false" [totalRecords]="FailurePoliciesCount" [resetPageOnSort]="true"
          [rowsPerPageOptions]="[5, 10, 20]" [loading]="loading" [paginator]="true" [rows]="10" [responsive]="true"
          scrollHeight="200px" [autoLayout]="true" [resizableColumns]="true">
          <ng-template pTemplate="caption" class="panel-heading">
            <div style="text-align: right">
              <!-- <input class="form-control input-sm" type="text" pInputText placeholder="{{'common.search' | translate}}" (input)="reportsTable.filterGlobal($event.target.value, 'contains')"> -->
            </div>
          </ng-template>
          <ng-template pTemplate="header">
            <tr>
              <th [pSortableColumn]="'CheckoutDetails.ReferenceId'" translate>
                invoice.reference_id
                <p-sortIcon [field]="'CheckoutDetails.ReferenceId'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="isEnglish ? 'insuredFullNameEn' : 'insuredFullNameAr'" translate>
                clients.ownerName
                <p-sortIcon [field]="isEnglish ? 'insuredFullNameEn' : 'insuredFullNameAr'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'insuredNIN'" translate>
                clients.ownerID
                <p-sortIcon [field]="'insuredNIN'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'driverNIN'" translate>
                clients.driverID
                <p-sortIcon [field]="'driverNIN'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th translate>
                <!-- [pSortableColumn]="isEnglish ? 'InsuranceCompany.NameEN' : 'InsuranceCompany.NameAR'"-->
                common.company
                <!--<p-sortIcon
                    [field]="isEnglish ? 'InsuranceCompany.NameEN' : 'InsuranceCompany.NameAR'"
                    ariaLabel="Activate to sort"
                    ariaLabelDesc="Activate to sort in descending order"
                    ariaLabelAsc="Activate to sort in ascending order"
                  ></p-sortIcon>-->
              </th>
              <th [pSortableColumn]="'createDate'" translate>
                policy.createDate
                <p-sortIcon [field]="'createDate'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'maxTries'" translate>
                  policy.Max_tries
                  <p-sortIcon [field]="'maxTries'" ariaLabel="Activate to sort"
                    ariaLabelDesc="Activate to sort in descending order"
                    ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
                </th>
              <th
                [pSortableColumn]="isEnglish ? 'policyStatusNameEn' : 'policyStatusNameAr'"
                translate>
                policy.policy_status
                <p-sortIcon
                  [field]="isEnglish ? 'policyStatusNameEn' : 'policyStatusNameAr'"
                  ariaLabel="Activate to sort" ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'productPrice'" translate>
                policy.quotationPrice
                <p-sortIcon [field]="'productPrice'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'benfitsPrice'" translate>
                policy.benfitsPrice
                <p-sortIcon [field]="'benfitsPrice'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'totalPrice'" translate>
                policy.policyPrice
                <p-sortIcon [field]="'totalPrice'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'totalPrice'" translate>
                policy.paidAmount
                <p-sortIcon [field]="'totalPrice'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th [pSortableColumn]="'channel'" translate>
                requestLogs.channel
                <p-sortIcon [field]="'channel'" ariaLabel="Activate to sort"
                  ariaLabelDesc="Activate to sort in descending order"
                  ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
              </th>
              <th>
                <span class="bx_left mr-l_m" translate>
                  common.action
                </span>
                <p-checkbox styleClass="bx_right mr-r_m" name="all" (onChange)="selectAll($event)"
                  [(ngModel)]="selectAllValue"></p-checkbox>
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-policy>
            <tr>
              <td style="word-wrap: break-word">
                {{ policy.referenceId || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ isEnglish ? policy.insuredFullNameEn : policy.insuredFullNameAr || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.insuredNIN || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.driverNIN || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ isEnglish ? policy.insuranceCompanyNameEn : policy.insuranceCompanyNameAr || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.createDate | date:'medium' }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.maxTries }}
              </td>
              <td style="word-wrap: break-word" [ngClass]="policy.policyStatuskey">
                {{ isEnglish ? policy.policyStatusNameEN : policy.policyStatusNameAr || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.productPrice || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.benfitsPrice || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.totalPrice || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.totalPrice || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word">
                {{ policy.channel || emptyStringValue }}
              </td>
              <td style="word-wrap: break-word;text-align: center">
                <button type="button" routerLink="/admin/policies/failure/edit/{{policy.referenceId}}"
                  routerLinkActive="active" class="btn btn-secondary edit-btn action-btn" translate>
                  {{policy.policyStatuskey === PolicyStatusEnum[PolicyStatusEnum.Available] ||
                  policy.policyStatuskey === PolicyStatusEnum[PolicyStatusEnum.PolicyFileDownloadFailure]||
                  policy.policyStatuskey === PolicyStatusEnum[PolicyStatusEnum.PolicyFileGeneraionFailure] ?
                  'policy.details' : 'insuranceCompany.edit' }}
                </button>
                <p-checkbox name="refernceId" [value]="policy.referenceId" [(ngModel)]="selectedPolicies"></p-checkbox>
                <button *ngIf="policy.policyStatuskey === PolicyStatusEnum[PolicyStatusEnum.PolicyFileDownloadFailure]"
                  type="button" (click)="reDownloadPolicyFile(policy.referenceId, policy.referenceId)"
                  class="btn download-btn action-btn" [ngClass]="policy.policyStatuskey"
                  translate>common.download</button>
                <button *ngIf="policy.policyStatuskey === PolicyStatusEnum[PolicyStatusEnum.PolicyFileGeneraionFailure]"
                  type="button" (click)="reGeneratePolicy(policy.referenceId, policy.referenceId)"
                  class="btn download-btn action-btn" [ngClass]="policy.policyStatuskey"
                  translate>common.generate</button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td style="text-align: center">
                {{ "common.noRecordsFound" | translate }}
              </td>
            </tr>
          </ng-template>
        </p-table>
        <!-- /.table-responsive -->
      </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<!-- <app-loader *ngIf="firstTime"></app-loader> -->
